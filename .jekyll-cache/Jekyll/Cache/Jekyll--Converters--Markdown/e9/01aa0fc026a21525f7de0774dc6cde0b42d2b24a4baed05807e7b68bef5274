I"Ê5<p>A few months ago, I picked up a box of Cisco 802.11 wireless access points at auction, a mixed box of 1200 and 1130 series APs in unknown condition. These little APs provide varying levels of 802.11 wireless service: 2.4 GHz B-only, 2.4 GHz B/G, and dual band A/B/G, depending on the model and the supplied radio(s). These seemed like they might be a good alternative to either running an AP on a wireless card in an existing router, or using a consumer AP/router as an access point. I finally got around to hacking on them and figuring out what they can do, and how to make them work as standalone units with my network. I‚Äôve since purchased some 1140 series Wireless-N access points from the same auction, and will cover those as well.</p>

<h2 id="test-network">Test Network</h2>

<p>I wanted to use the following layout for a test network, it‚Äôs similar to what I ended up with for my home/office network:</p>

<ul>
  <li>VLAN 10 for LAN traffic</li>
  <li>VLAN 11 for Wireless traffic</li>
  <li>VLAN 20 for management traffic</li>
  <li>Access to everything from LAN</li>
  <li>Access to Internet and a few select LAN devices for Wireless</li>
  <li>IPv6 on all VLANs</li>
</ul>

<p>The above VLAN numbering will be used in examples, below.</p>

<h2 id="powering-the-access-point">Powering the Access Point</h2>

<p>All of the APs discussed will operate on <a href="https://en.wikipedia.org/wiki/Power_over_Ethernet">Power over Ethernet</a>. Cisco claims 802.3af compliance, which is a protocol whereby the power supply negotiates power with the powered device (PD), rather than just putting DC on unused pairs in the Ethernet cable. Additionally, the APs tested have a jack for an external power supply. I chose to power them with Power over Ethernet since I‚Äôve got a few PoE injectors and switches.</p>

<p>If you don‚Äôt have an injector or a switch that provides 802.3af PoE capability, you have many options for injectors. For test setups, I have a few Proxim AE Model 4301 power injectors. These injectors use only the spare pairs in a 10/100 mbit Ethernet connection for power and will work with many well-behaved 802.3af PDs including Cisco APs. They‚Äôre a small, self-contained unit with the power supply built into the unit, so no external wall wart or line lump is required, just an IEC power cable. They won‚Äôt destroy non-PoE gear plugged into the power output port, which is apparently a problem with some cheaper PoE injectors.</p>

<p><strong>WARNING</strong> Do not buy a ‚Äúpassive‚Äù injector or any power source which does not explicitly state 802.3af compliance. You can destroy your AP, the injector, or both.</p>

<p>It seems there‚Äôs a lot of misunderstanding and mis-marketing for ‚Äú802.3af Compliant‚Äù devices! The standard states that power can be provided either on the ‚Äúspare‚Äù pairs (unused with 10/100 mbit Ethernet), or on the active pairs. In the case of Gigabit Ethernet, there are no spare pairs. In testing with both the Proxim injectors and a Foundry/Brocade FastIron PoE switch, it was discovered that the Cisco 1200 and 1140 series APs appeared to be ‚Äúfully compliant,‚Äù while the Cisco 1130 APs appeared to only accept power on the ‚Äúspare‚Äù pairs. Keep that in mind if you already have a PoE capable switch.</p>

<h2 id="firmware-updates">Firmware Updates</h2>

<p>The first step in getting APs up and going is to make sure you have the proper firmware loaded. Many Cisco APs purchased used will be loaded with the LWAPP (LightWeight Access Point Protocol) firmware, which is intended for use with a centralized AP controller. All of the APs discussed here can be loaded with either the LWAPP firmware, or the ‚ÄúAutonomous AP‚Äù firmware. For the 1200 series APs, there‚Äôs also a vxWorks based firmware, which won‚Äôt be discussed. For standalone use, the Autonomous IOS image is what you‚Äôll want. Even APs shipped with factory LWAPP firmware (AIR-LAPxxxx model numbers) can be upgraded to Autonomous mode.</p>

<p>Obtaining the firmware is an exercise left to the reader: a free Cisco support account will get you some firmware options, but not all. Only the ‚ÄúIP Base‚Äù level firmware will be discussed ‚Äì that is, no features requiring a higher level of licensing will be used.</p>

<p>It helps to have a Cisco console cable and USB -&gt; RS-232 adapter when doing firmware updates. It‚Äôs possible to do them without a console cable, using only the indicator LEDs on the AP to determine what‚Äôs going on. Cables are cheaply available online, and can be purchased with built-in USB converters, if desired. I‚Äôve got the old style RJ-45 rollover cable, a RJ-45 to DB9 converter, and a Prolific based USB converter, so I can‚Äôt comment on any of the current all-in-one offerings.</p>

<p>I followed <a href="https://paulbeyer.wordpress.com/2010/01/16/converting-a-cisco-ap-from-lwapp-to-autonomous-mode/">this guide</a> for reloading the firmware on my APs. You don‚Äôt need to know the current password(s) for the AP, in the event that you‚Äôve purchased a used unit that hasn‚Äôt been reset. I used the <code>in.tftpd</code> server bundled with <a href="http://www.slackware.com">Slackware Linux</a>, storing the firmware files in <code>/srv/tftp/</code>. Make sure permissions are correct, and run the TFTP daemon:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">in</span>.tftpd <span class="nt">-L</span> <span class="nt">-a</span> 255.255.255.255 <span class="nt">-s</span> /srv/tftp</code></pre></figure>

<p>You need to tell <code>in.tftpd</code> to listen on the broadcast address, <code>255.255.255.255</code>, with the <code>-a</code> switch. This was missing from the linked guides, and all others I found. By default, <code>in.tftpd</code> binds to any available address, but won‚Äôt respond to broadcast requests unless you tell it to. Took about an hour and a half of head-desk to figure that out!</p>

<h2 id="initial-configuration">Initial Configuration</h2>

<p>After a firmware reload, the AP will come up in Autonomous IOS and try to pull an IP from DHCP on the Ethernet interface. If you‚Äôve got the console cable connected, you‚Äôll see the IP assignment. You can connect to a HTTP configuration app on the AP‚Äôs address, or Telnet to it. The default username/password is Cisco/Cisco, and the enable password is Cisco as well. If you‚Äôre going to set up managment VLANs (as below), you‚Äôll need to either do that configuration from the serial console, or upload a configuration and wait for the network to reconfigure itself.</p>

<p>If you list interfaces, you‚Äôll see that the IP is assigned to BVI1, not <code>FastEthernet0</code> or <code>GigabitEthernet0</code> as you might have expected. That brings us to‚Ä¶</p>

<h2 id="what-is-the-bvi-anyway">What is the BVI, Anyway?</h2>

<p>There seems to be a lot of confusion about this, from forum posts to Cisco documentation, to what appears to be semi-official Cisco writeups by CCIEs or something. You see a lot of posts voted as ‚Äúcorrect answer‚Äù on the usual community help forums suggesting that BVI interfaces are some special sort of routing interface, that you‚Äôll need to use DHCP relays on them because they‚Äôre a separate Layer 2 broadcast domain, et c. Incorrect.</p>

<p>The BVI is the Bridge Virtual Interface. It‚Äôs analogous to the various VLAN interfaces you can have on e.g. Catalyst switches running IOS. <code>BVI1</code> is a special case, at least on Aironet APs running IOS, in that it‚Äôs always tied to IRB <code>bridge-group 1</code>. You can‚Äôt define a different <code>bridge-group</code>, and it‚Äôs kind of unclear as to whether you can create more BVI interfaces. A <code>bridge-group</code> is a way of bridging interfaces together in a Layer 2 bridge, just like a switch does. It‚Äôs analogous to using <code>bridge-utils</code> in Linux or adding interfaces to <code>bridge0</code> in OpenBSD. As such, the BVI is just a virtual interface that‚Äôs bridged in.</p>

<p>Typical application would be to ‚Äútap in‚Äù on a bridge between one or more other interfaces; say, <code>FastEthernet0</code> and <code>Dot11Radio0</code> on an AP. You leave both <code>fa0</code> and <code>dot0</code> without IP addresses, bridge in <code>BVI1</code>, and assign the IP there. All three are part of the same <code>bridge-group</code> (you assign <code>bridge-group 1</code> on <code>fa0</code> and <code>dot0</code>, it‚Äôs implied on <code>BVI1</code>) and act just like three separate things plugged into an access switch. I guess the confusion stems from the implied association between <code>BVI1</code> and <code>bridge-group 1</code>.</p>

<p>With Cisco IOS 12, you can coerce IOS into putting <code>BVI1</code> on a VLAN other than the default/native VLAN for the Ethernet interface. This doesn‚Äôt seem to be possible with IOS 15.</p>

<h2 id="separate-management-vlan-with-ios-12">Separate Management VLAN With IOS 12</h2>

<p>If you don‚Äôt want to associate <code>BVI1</code> with the native VLAN on the APs Ethernet interface, you can coerce IOS into using a VLAN with IOS 12. Configuration is a little unintuitive, and it seems that Cisco doesn‚Äôt really want APs configured in this way. The following is an example configuration from the Catalyst 2940 switch on my test network, which provides the VLAN trunk port to the AP under test:</p>

<figure class="highlight"><pre><code class="language-ios" data-lang="ios">interface FastEthernet0/5
 switchport trunk native vlan 99
 switchport trunk allowed vlan 11,20
 switchport mode trunk
 switchport nonegotiate</code></pre></figure>

<p>Setting the native VLAN to 99 effectively blackholes any untagged traffic coming into the port, provided nothing is using VLAN 99. No untagged traffic will leave the port, since VLAN 99 isn‚Äôt used for anything other than a blackhole in my configuration. This is typically a good idea as an additional layer in securing your network. We‚Äôre going to allow tagged packets for VLAN 11 (Wireless subnet) and VLAN 20 (management subnet) across the trunk.</p>

<p>Basically, we want to assign <code>bridge-group 1</code> to something other than <code>FastEthernet0</code> or <code>GigabitEthernet0</code>, but IOS won‚Äôt let you do</p>

<figure class="highlight"><pre><code class="language-ios" data-lang="ios">conf ter
inter fa0
no bridge-group 1</code></pre></figure>

<p>And, you can‚Äôt add a subinterface to <code>bridge-group 1</code> without removing the parent interface! The following snippet will force <code>FastEthernet0</code> out of <code>bridge-group 1</code>:</p>

<figure class="highlight"><pre><code class="language-ios" data-lang="ios">conf ter
inter fa0
bridge-group 2
no bridge-group 2</code></pre></figure>

<p>With that taken care of, you can now create a subinterface for VLAN 20 and assign it to <code>bridge-group 1</code>. The following configuration will put managment on VLAN 20:</p>

<figure class="highlight"><pre><code class="language-ios" data-lang="ios">interface FastEthernet0
    no ip address
    no ip route-cache
    duplex auto
    speed auto

interface FastEthernet0.20
    encapsulation dot1Q 20
    no ip route-cache
    bridge-group 1
    no bridge-group 1 source-learning
    bridge-group 1 spanning-disabled

interface BVI1
    ip address dhcp client-id FastEthernet0
    no ip route cache</code></pre></figure>

<p>From this point, configure the AP as you normally would. There are many good guides for configuring IOS APs from the command line. I don‚Äôt personally use the web interface, so I can‚Äôt say whether it will work properly with a non-native management VLAN.</p>

<h2 id="ios-15-and-vlan-issues">IOS 15 and VLAN Issues</h2>

<p>IOS 15 is quite resistant to having <code>BVI1</code> sit on anything other than the native VLAN. It‚Äôll lie to you about what‚Äôs going on. You can‚Äôt use the <code>bridge-group</code> swap as mentioned above to get <code>bridge-group 1</code> off of <code>GigabitEthernet0</code>. You can upload a configuration from e.g. TFTP with <code>bridge-group 1</code> assigned to a different interface, but you‚Äôll have to copy it to <code>startup-config</code> and reboot. You can also do the following:</p>

<figure class="highlight"><pre><code class="language-ios" data-lang="ios">conf ter
inter gi0.10
encap dot1q 10 native
inter gi0
bridge-group 2
inter gi0.10
no encap dot1q 10 native
encap dot1q 10</code></pre></figure>

<p>Now, if you put a port into monitor mode (port mirroring), at least on a Cisco switch (I used a little Catalyst 2940), and you have Dot1Q encapsulation turned on for the destination port, THE SWITCH WILL ADD VLAN HEADERS BACK! You‚Äôll see traffic moving around with VLAN 10 tags. I guess this is some sort of diagnostic translation where the monitor session is automatically assigning the switchport‚Äôs native VLAN header to packets that are really untagged.</p>

<p>So how do we actually know these are untagged, when everything is pointing to them being tagged? Well, for one, that‚Äôs how <code>switchport trunk native vlan 10</code> works. Also, you can break out your trusty 10baseT hub (not a switch, a hub ‚Äì multiport repeater) and use <em>that</em> to mirror traffic to your packet sniffer. Being dumb repeater devices, hubs won‚Äôt mess with any of your traffic, and you‚Äôll see untagged packets flying back and forth that you might have expected to be tagged as VLAN 10.</p>

<p>Just for completeness, the same setup was tried with the same AP running IOS 12 and the above configuration tricks. <code>BVI1</code> traffic is indeed encapsulated with the proper VLAN headers under IOS 12.</p>

<p class="center">
    <script language="javascript" src="https://services.glitchworks.net/counters/cisco_aps"></script> WRT54Gs replaced
</p>

:ET