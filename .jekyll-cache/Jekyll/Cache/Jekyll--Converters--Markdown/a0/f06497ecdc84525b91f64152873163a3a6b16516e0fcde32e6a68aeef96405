I"Lì<p>This site is largely a static site, built with the help of <a href="https://jekyllrb.com/">Jekyll</a>. Jekyll essentially takes some templates, a bunch of Markdown (or your choice of markup language), and turns out HTML suitable for direct deployment to a HTTP server. Jekyll replaced a bunch of static HTML and maintenance scripts <a href="http://www.glitchwrks.com/2012/04/20/jekyll-upgrade">in April 2012</a>. It‚Äôs a nice, ‚Äúblog aware‚Äù solution that doesn‚Äôt involve running anything server-side. It‚Äôs also written in Ruby, which is one of my preferred languages. Being open source means it‚Äôs easy to hack on, and recent site maintenance brought a few points to mind that got me to actually write some plugins for Jekyll.</p>

<p>There were a few consistent pain points across the Markdown source for the site, as follows:</p>

<ul>
  <li>Linked thumbnail images required a lot of boilerplate and manual editing</li>
  <li>Contact form links were scattered everywhere and required a lot of updating if URLs changed (they have three times, as of writing)</li>
  <li>Counter includes were not great, and resulted in an extra paragraph element</li>
  <li>‚ÄúDanger‚Äù warnings at the top of articles required a block of HTML</li>
  <li>Plaintext and highlighted code blocks needed more graphical separation from writeup text</li>
</ul>

<p>Fortunately, plugin support is included in Jekyll. I started with <a href="http://jekyllrb.com/docs/plugins/">the official documentation</a>, finding that Liquid tags would probably solve most of my problems. Starting with a custom counter tag seemed like an easy, straightforward start. By the time I was ready to start on the linked image tag, I‚Äôd already found a pattern for custom tags that I liked. Rather than start at the earliest steps, we will begin with conventions I settled on for custom tags.</p>

<h2 id="plugin-structure-basic-tag-setup">Plugin Structure, Basic Tag Setup</h2>

<p>In the simplest case, custom plugins are located under the <code>_plugins</code> directory in your Jekyll project. Seeing as how my plugins were to be tightly coupled to glitchwrks.com, I didn‚Äôt see the benefit into breaking them out into separate gems. For now, they live under <code>_plugins</code>.</p>

<p>The offical documentation for writing custom tags starts off with extending <code>Liquid::Tag</code> in a class within the <code>Jekyll</code> module. The most basic Liquid tag simply extends <code>Liquid::Tag</code> and implements the <code>render</code> method, taking one parameter (the context) and returning a string containing the HTML to be rendered. Tags are set up with the <code>initialize</code> method which, if implemented, must take three arguments and call <code>super</code> at some point. Tags must be registered with the Liquid template engine to make them available in templates. The tags for this site largely inherit from a base class, <code>GlitchWorks::Tag</code>, which implemets this base functionality and a few other convenience methods. Let‚Äôs take a look at it:</p>

<div class="pageview">
  <div class="pageview-header codeblock-header">.:[_plugins/glitchworks_tag.rb]:.</div>
    
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'glitchworks_base'</span>

<span class="k">module</span> <span class="nn">GlitchWorks</span>
  <span class="k">class</span> <span class="nc">Tag</span> <span class="o">&lt;</span> <span class="no">Liquid</span><span class="o">::</span><span class="no">Tag</span>
    <span class="kp">include</span> <span class="no">GlitchWorks</span><span class="o">::</span><span class="no">Base</span>

    <span class="k">def</span> <span class="nf">render</span> <span class="p">(</span><span class="n">context</span><span class="p">)</span>
      <span class="vi">@context</span> <span class="o">=</span> <span class="n">context</span>
      <span class="n">internal_render</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

</div>

<p>This class depends on <code>GlitchWorks::Base</code>, which is a module that contains some methods common to both tags and blocks. It looks like this:</p>

<div class="pageview">
  <div class="pageview-header codeblock-header">.:[_plugins/glitchworks_base.rb]:.</div>
    
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">GlitchWorks</span>
  <span class="k">module</span> <span class="nn">Base</span>

    <span class="k">def</span> <span class="nf">initialize</span> <span class="p">(</span><span class="n">tag_name</span><span class="p">,</span> <span class="n">params_string</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
      <span class="k">super</span>
      <span class="n">bind_params</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="s2">"{</span><span class="si">#{</span><span class="n">params_string</span><span class="si">}</span><span class="s2">}"</span><span class="p">))</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">markdown_converter</span>
      <span class="vi">@context</span><span class="p">.</span><span class="nf">registers</span><span class="p">[</span><span class="ss">:site</span><span class="p">].</span><span class="nf">find_converter_instance</span><span class="p">(</span><span class="o">::</span><span class="no">Jekyll</span><span class="o">::</span><span class="no">Converters</span><span class="o">::</span><span class="no">Markdown</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">id</span>
      <span class="vi">@context</span><span class="p">.</span><span class="nf">registers</span><span class="p">[</span><span class="ss">:page</span><span class="p">].</span><span class="nf">id</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">).</span><span class="nf">last</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="s1">'-'</span><span class="p">,</span> <span class="s1">'_'</span><span class="p">).</span><span class="nf">downcase</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">category</span>
      <span class="vi">@context</span><span class="p">.</span><span class="nf">registers</span><span class="p">[</span><span class="ss">:page</span><span class="p">][</span><span class="s1">'category'</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

</div>

<p>Here we can see that the <code>initialize</code> method expects the third parameter to be a params string, which it evals and passes into <code>bind_params</code>, which is not implemented in either <code>GlitchWorks::Base</code> or <code>GlitchWorks::Tag</code>. Rather than doing work directly in the <code>render</code> method, the tag class assigns the context to an instance variable, and calls <code>internal_render</code> which is again implemented by subclasses only.</p>

<p>The helper (or <a href="https://en.wikipedia.org/wiki/Law_of_Demeter">Law of Demeter</a>) methods in <code>GlitchWorks::Base</code> include some useful tools that were not readily apparent from either the Jekyll or Liquid documentation. <code>markdown_converter</code> grabs an instance of the configured Markdown parser from the project configuration. <code>id</code> parses this site‚Äôs concept of a writeup ID out of the information Jekyll makes available to us (<code>@context.registers[:page].id</code> returns the full permalink). <code>category</code> pulls the page‚Äôs category.</p>

<p>Note that the <code>:page</code> element on the registers is a recentish addition to Jekyll, as discussed in <a href="https://stackoverflow.com/questions/7478731/how-do-i-detect-the-current-page-in-a-jekyll-tag-plugin?rq=1">this StackOverflow post</a>. Doing an <code>inspect</code> on <code>registers[:page]</code> results in an overwhelming heap of output. It returns an instance of <code>Jekyll::Drops::DocumentDrop</code>, which behaves somewhat like a hash.</p>

<h2 id="the-counter-tag-a-simple-case">The Counter Tag, a Simple Case</h2>

<p>As mentioned, this rabbit hole was entered due to the want for a simpler way of including counters on pages. This site‚Äôs counters are provided by <a href="https://github.com/chapmajs/site_services">a small Sinatra app</a> and included as JavaScript that immediately does a <code>document.write()</code> with the hit count. Here‚Äôs the code for the <code>counter</code> tag, which accomplishes this:</p>

<div class="pageview">
  <div class="pageview-header codeblock-header">.:[_plugins/counter_tag.rb]:.</div>
    
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'glitchworks_tag'</span>

<span class="k">class</span> <span class="nc">GlitchWorks::CounterTag</span> <span class="o">&lt;</span> <span class="no">GlitchWorks</span><span class="o">::</span><span class="no">Tag</span>
  
  <span class="k">def</span> <span class="nf">bind_params</span> <span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="vi">@text</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:text</span><span class="p">]</span>
    <span class="vi">@id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">id</span>
    <span class="vi">@id</span> <span class="o">||</span> <span class="k">super</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">internal_render</span>
    <span class="o">&lt;&lt;~</span><span class="no">COUNTER</span><span class="sh">
    &lt;p class="center"&gt;
        &lt;script language="javascript" src="https://services.glitchworks.net/counters/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="sh">"&gt;&lt;/script&gt; </span><span class="si">#{</span><span class="vi">@text</span><span class="si">}</span><span class="sh">
    &lt;/p&gt;
</span><span class="no">    COUNTER</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Liquid</span><span class="o">::</span><span class="no">Template</span><span class="p">.</span><span class="nf">register_tag</span><span class="p">(</span><span class="s1">'counter'</span><span class="p">,</span> <span class="no">GlitchWorks</span><span class="o">::</span><span class="no">CounterTag</span><span class="p">)</span></code></pre></figure>

</div>

<p>The counter tag inherits from <code>GlitchWorks::Tag</code> and implements the two methods referenced but not implemented in either the parent class or the base module: <code>bind_params</code> and <code>internal_render</code>. It also overrides the <code>id</code> method, allowing for an optional ID to be supplied when the tag is called. This feature was included since some of the early hit counters on this site are referenced by an ID that does not match what the <code>id</code> method returns.</p>

<p>The final line in the file registers <code>GlitchWorks::CounterTag</code> as the <code>counter</code> tag with the Liquid template engine, allowing it to be called as such:</p>

<p><code>{% counter :id =&gt; 'foo', :text =&gt; 'bar baz' %}</code></p>

<p>and producing the output:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"center"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;script </span><span class="na">language=</span><span class="s">"javascript"</span> <span class="na">src=</span><span class="s">"https://services.glitchworks.net/counters/foo"</span><span class="nt">&gt;&lt;/script&gt;</span> bar baz
<span class="nt">&lt;/p&gt;</span></code></pre></figure>

<p>(fun fact: the above is generated directly with the tag plugin)</p>

<p>This tag essentially defined my tag and block calling convention: the first keyword is the name of the tag, and everything after it gets passed to the second argument in the <code>initialize</code> method of the tag class. As seen in <code>GlitchWorks::Base</code>, our <code>initialize</code> method evals the second argument and passes it off to <code>bind_params</code>. All of the plugins for this site treat the string as a string representation of a Ruby hash.</p>

<h2 id="linked-image-thumbnails">Linked Image Thumbnails</h2>

<p>The second custom tag created helps with thumbnail images in writeups, which have alt text and are linked to a full resolution version. Every writeup follows the convention of storing images in <code>/images/category/id</code>. Thumbnails are stored in <code>/images/category/id/scaled</code> and always have the same filename as the full-size image. This pattern is great for organization, but was somewhat verbose when using standard Markdown linked image syntax. Here‚Äôs the tag plugin that handles linked images:</p>

<div class="pageview">
  <div class="pageview-header codeblock-header">.:[_plugins/linked_image_tag.rb]:.</div>
    
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'glitchworks_tag'</span>

<span class="k">class</span> <span class="nc">GlitchWorks::LinkedImageTag</span> <span class="o">&lt;</span> <span class="no">GlitchWorks</span><span class="o">::</span><span class="no">Tag</span>
  
  <span class="k">def</span> <span class="nf">bind_params</span> <span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="vi">@alt_texts</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:alt_texts</span><span class="p">]</span> <span class="o">||</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="ss">:alt_text</span><span class="p">]]</span>
    <span class="vi">@files</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:files</span><span class="p">]</span> <span class="o">||</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="ss">:file</span><span class="p">]]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">internal_render</span>
    <span class="n">return_string</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'&lt;div class="center"&gt;'</span><span class="p">]</span>

    <span class="vi">@files</span><span class="p">.</span><span class="nf">each_with_index</span> <span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="p">,</span> <span class="n">idx</span><span class="o">|</span> <span class="n">return_string</span> <span class="o">&lt;&lt;</span> <span class="n">linked_image_string</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="vi">@alt_texts</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="p">}</span>

    <span class="n">return_string</span> <span class="o">&lt;&lt;</span> <span class="s1">'&lt;/div&gt;'</span>
    <span class="n">return_string</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">linked_image_string</span> <span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">alt_text</span><span class="p">)</span>
    <span class="s2">"  &lt;a href='/images/</span><span class="si">#{</span><span class="n">category</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">'&gt;&lt;img src='/images/</span><span class="si">#{</span><span class="n">category</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">/scaled/</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">' alt='</span><span class="si">#{</span><span class="n">alt_text</span><span class="si">}</span><span class="s2">'&gt;&lt;/a&gt;"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Liquid</span><span class="o">::</span><span class="no">Template</span><span class="p">.</span><span class="nf">register_tag</span><span class="p">(</span><span class="s1">'linked_image'</span><span class="p">,</span> <span class="no">GlitchWorks</span><span class="o">::</span><span class="no">LinkedImageTag</span><span class="p">)</span></code></pre></figure>

</div>

<p>This tag is meant to handle the case of a single linked image, as well as multiple linked images centered within the same <code>&lt;div&gt;</code> ‚Äì the <a href="/2017/07/24/ipc-recap">Sun SPARCstation IPC Recap writeup</a> demonstrates how the images appear. The <code>bind_params</code> method takes care of handling both cases: it expects either <code>:files</code> and <code>:alt_texts</code> to be passed in, or automatically throws <code>:file</code> and <code>:alt_text</code> into single-element arrays.</p>

<p>The <code>internal_render</code> method loops over the supplied files, creating thumbnails linked to the full sized images. It can be called as such:</p>

<p><code>{% linked_image :file =&gt; 'foo.jpg', :alt_text =&gt; 'bar baz' %}</code></p>

<p>and produces the output:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"center"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">'/images/coding/jekyll_plugins/foo.jpg'</span><span class="nt">&gt;&lt;img</span> <span class="na">src=</span><span class="s">'/images/coding/jekyll_plugins/scaled/foo.jpg'</span> <span class="na">alt=</span><span class="s">'bar baz'</span><span class="nt">&gt;&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span></code></pre></figure>

<h2 id="contact-form-links">Contact Form Links</h2>

<p>The tag for inserting contact form links was created to centrailze configuration and reduce duplication. The contact form is currently part of <a href="https://github.com/glitchwrks/rails_services">the rails_services project</a>, but had previously been:</p>

<ul>
  <li>a plain email address</li>
  <li>an obfuscated email address</li>
  <li>a link to a static page that did a <code>POST</code> to the <a href="https://github.com/chapmajs/site_services">site_services app</a></li>
</ul>

<p>Changing it involved some find-and-replace against the site‚Äôs source, as well as manual cleanup of missed links. With the contact tag, the mechanism is in one place, and only one file requires changing when the method of contact changes in the future. Here‚Äôs the tag plugin:</p>

<div class="pageview">
  <div class="pageview-header codeblock-header">.:[_plugins/contact_tag.rb]:.</div>
    
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'glitchworks_tag'</span>

<span class="k">class</span> <span class="nc">GlitchWorks::ContactTag</span> <span class="o">&lt;</span> <span class="no">GlitchWorks</span><span class="o">::</span><span class="no">Tag</span>
  
  <span class="k">def</span> <span class="nf">bind_params</span> <span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="vi">@text</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:text</span><span class="p">]</span> <span class="o">||</span> <span class="s1">'contact us'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">internal_render</span>
    <span class="s2">"&lt;a href='https://services.glitchworks.net/ng/messages/new'&gt;</span><span class="si">#{</span><span class="vi">@text</span><span class="si">}</span><span class="s2">&lt;/a&gt;"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Liquid</span><span class="o">::</span><span class="no">Template</span><span class="p">.</span><span class="nf">register_tag</span><span class="p">(</span><span class="s1">'contact'</span><span class="p">,</span> <span class="no">GlitchWorks</span><span class="o">::</span><span class="no">ContactTag</span><span class="p">)</span></code></pre></figure>

</div>

<p>This tag is very simple, requiring only an optional <code>:text</code> parameter and otherwise rendering a static string. The text defaults to ‚Äòcontact us,‚Äô the most common link text used before replacing Markdown links with the custom tag. Here‚Äôs how it is called:</p>

<p><code>{% contact :text =&gt; 'let me know' %}</code></p>

<p>and produces the output:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">'https://services.glitchworks.net/ng/messages/new'</span><span class="nt">&gt;</span>let me know<span class="nt">&lt;/a&gt;</span></code></pre></figure>

<h2 id="liquid-tag-blocks">Liquid Tag Blocks</h2>

<p>The next type of tag is the Liquid tag block, which is an element that requires an opening and closing tag. This is likely familiar to most Jekyll users in the <code>highlight</code> tag. Usage is covered in the <a href="https://github.com/Shopify/liquid/wiki/Liquid-for-Programmers#create-your-own-tag-blocks">Liquid for Programmers</a> documentation.</p>

<p>To make use of custom tag blocks, I introduced a new parent class, <code>GlitchWorks::Block</code>:</p>

<div class="pageview">
  <div class="pageview-header codeblock-header">.:[_plugins/glitchworks_block.rb]:.</div>
    
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'glitchworks_base'</span>

<span class="k">module</span> <span class="nn">GlitchWorks</span>
  <span class="k">class</span> <span class="nc">Block</span> <span class="o">&lt;</span> <span class="no">Liquid</span><span class="o">::</span><span class="no">Block</span>
    <span class="kp">include</span> <span class="no">GlitchWorks</span><span class="o">::</span><span class="no">Base</span>

    <span class="k">def</span> <span class="nf">render</span> <span class="p">(</span><span class="n">context</span><span class="p">)</span>
      <span class="vi">@context</span> <span class="o">=</span> <span class="n">context</span>
      <span class="vi">@text</span> <span class="o">=</span> <span class="k">super</span>
      <span class="n">internal_render</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

</div>

<p>The big difference here is that <code>GlitchWorks::Block</code> extends <code>Liquid::Block</code> rather than <code>Liquid::Tag</code>. The <code>initialize</code> method is handled in the same way; however, we must call <code>super</code> in the <code>render</code> method to get the text contained in the tag block. Our parent class assigns the contents of the tag block to the instance variable <code>@text</code>, for later use in tag block plugins.</p>

<h2 id="text-block-tag">Text Block Tag</h2>

<p>The textblock tag is currently the simplest tag block implementation in the project. It simply wraps text in <code>&lt;pre&gt;</code> tags and puts a <code>&lt;div&gt;</code> with CSS decoration around it. This is to set the text apart from the rest of the document, providing the visual clue that it is effectively its own subdocument. Here‚Äôs the implementation:</p>

<div class="pageview">
  <div class="pageview-header codeblock-header">.:[_plugins/text_block.rb]:.</div>
    
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">GlitchWorks::TextBlock</span> <span class="o">&lt;</span> <span class="no">GlitchWorks</span><span class="o">::</span><span class="no">Block</span>

  <span class="k">def</span> <span class="nf">bind_params</span> <span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:title</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">internal_render</span>
    <span class="o">&lt;&lt;~</span><span class="no">TEXTBLOCK</span><span class="sh">
    &lt;div class="pageview"&gt;
      &lt;div class="pageview-header codeblock-header"&gt;.:[</span><span class="si">#{</span><span class="vi">@title</span><span class="si">}</span><span class="sh">]:.&lt;/div&gt;
        &lt;pre&gt;</span><span class="si">#{</span><span class="vi">@text</span><span class="si">}</span><span class="sh">&lt;/pre&gt;
    &lt;/div&gt;
</span><span class="no">    TEXTBLOCK</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Liquid</span><span class="o">::</span><span class="no">Template</span><span class="p">.</span><span class="nf">register_tag</span><span class="p">(</span><span class="s1">'textblock'</span><span class="p">,</span> <span class="no">GlitchWorks</span><span class="o">::</span><span class="no">TextBlock</span><span class="p">)</span></code></pre></figure>

</div>

<p>No mystery here, the <code>:title</code> parameter is assigned in <code>bind_params</code>, and the <code>@text</code> instance variable is set in the parent class‚Äôs <code>render</code> method. It can be called like this:</p>

<pre><code>{% textblock :title =&gt; 'a block of text' %}
some plain text
    whitespace preserved
{% endtextblock %}
</code></pre>

<p>and produces the output:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pageview"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pageview-header codeblock-header"</span><span class="nt">&gt;</span>.:[a block of text]:.<span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;pre&gt;</span>
some plain text
    whitespace preserved
<span class="nt">&lt;/pre&gt;</span>
<span class="nt">&lt;/div&gt;</span></code></pre></figure>

<h2 id="the-danger-block">The Danger Block</h2>

<p>A few writeups have warnings at the top of the article concerning <a href="http://www.catb.org/jargon/html/B/Bad-Thing.html">Bad Things</a> that may happen if you just use examples from the article without understanding what‚Äôs going on. Articles that use it include <a href="/2016/03/21/eprom-timer">the EPROM timer</a>, in which the computer is put in charge of mains power, and <a href="/2017/01/16/removing-cookies-sessions-rails-5">Removing Cookies and Sessions from Rails 5</a>, which may make your Rails app less secure if you don‚Äôt know why you‚Äôre disabling cookies and/or sessions.</p>

<p>This warning was previously achieved with HTML inlined in the Markdown template for the article, which was suboptimal. Not only was there plain HTML present, but Markdown couldn‚Äôt be used within the HTML tags, meaning the link to <a href="http://www.catb.org/jargon/html/B/Bad-Thing.html">Bad Thing in the Jargon File</a> had to be done as an anchor tag. The custom tag block is implemented as follows:</p>

<div class="pageview">
  <div class="pageview-header codeblock-header">.:[_plugins/danger_block.rb]:.</div>
    
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">GlitchWorks::DangerBlock</span> <span class="o">&lt;</span> <span class="no">GlitchWorks</span><span class="o">::</span><span class="no">Block</span>

  <span class="k">def</span> <span class="nf">bind_params</span> <span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="vi">@add_break</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:add_break</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">internal_render</span>
    <span class="o">&lt;&lt;~</span><span class="no">DANGER</span><span class="sh">
    </span><span class="si">#{</span><span class="s2">"&lt;div&gt;&amp;nbsp;&lt;/div&gt;"</span> <span class="k">if</span> <span class="vi">@add_break</span><span class="si">}</span><span class="sh">
    &lt;div class='error_explanation'&gt;
      &lt;div class='error_explanation_content'&gt;
        &lt;p&gt;
          </span><span class="si">#{</span><span class="n">markdown_converter</span><span class="p">.</span><span class="nf">convert</span><span class="p">(</span><span class="vi">@text</span><span class="p">)</span><span class="si">}</span><span class="sh">
        &lt;/p&gt;
      &lt;/div&gt;
    &lt;/div&gt;
</span><span class="no">    DANGER</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Liquid</span><span class="o">::</span><span class="no">Template</span><span class="p">.</span><span class="nf">register_tag</span><span class="p">(</span><span class="s1">'danger'</span><span class="p">,</span> <span class="no">GlitchWorks</span><span class="o">::</span><span class="no">DangerBlock</span><span class="p">)</span></code></pre></figure>

</div>

<p>The danger block tag makes use of the LoD accessor <code>markdown_converter</code>, which is defined in <code>GlitchWorks::Base</code>. It passes the contents of the block, assigned to <code>@text</code>, into the generator and displays it in a styled <code>&lt;div&gt;</code> to draw attention to the warning it contains. There‚Äôs an optional <code>:add_break</code> parameter, which just inserts an unstyled <code>&lt;div&gt;</code> with a non-breaking space. This is necessary to add a bit of space between the warning if it immediately follows the header in a writeup. Here‚Äôs an example of its use:</p>

<pre><code>{% danger %}
Don't even *think* about putting a fork in the receptacle!
{% enddanger %}
</code></pre>

<p>It generates the following HTML:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'error_explanation'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'error_explanation_content'</span><span class="nt">&gt;</span>
    
<span class="nt">&lt;p&gt;</span>Don‚Äôt even <span class="nt">&lt;em&gt;</span>think<span class="nt">&lt;/em&gt;</span> about putting a fork in the receptacle!<span class="nt">&lt;/p&gt;</span>

  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span></code></pre></figure>

<h2 id="code-block-tag-an-extension-of-jekylls-highlight-tag">Code Block Tag: an Extension of Jekyll‚Äôs Highlight Tag</h2>

<p>The codeblock tag is a direct extension of Jekyll‚Äôs <code>highlight</code> tag, and as such it does not inherit from any of the parent classes or include the base module described above. In that sense, it‚Äôs one of the more straightforward tag blocks to examine:</p>

<div class="pageview">
  <div class="pageview-header codeblock-header">.:[_plugins/code_block.rb]:.</div>
    
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">GlitchWorks</span>
  <span class="k">class</span> <span class="nc">CodeBlock</span> <span class="o">&lt;</span> <span class="no">Jekyll</span><span class="o">::</span><span class="no">Tags</span><span class="o">::</span><span class="no">HighlightBlock</span>

    <span class="k">def</span> <span class="nf">initialize</span> <span class="p">(</span><span class="n">tag_name</span><span class="p">,</span> <span class="n">params_string</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
      <span class="n">bind_params</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="s2">"{</span><span class="si">#{</span><span class="n">params_string</span><span class="si">}</span><span class="s2">}"</span><span class="p">))</span>
      <span class="k">super</span><span class="p">(</span><span class="n">tag_name</span><span class="p">,</span> <span class="vi">@language</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">bind_params</span> <span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="vi">@title</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:title</span><span class="p">]</span>
      <span class="vi">@language</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:language</span><span class="p">]</span> <span class="n">or</span> <span class="k">raise</span> <span class="no">SyntaxError</span><span class="p">,</span> <span class="s2">"Error in tag 'codeblock', :language parameter is required"</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">render</span> <span class="p">(</span><span class="n">context</span><span class="p">)</span>
      <span class="vi">@context</span> <span class="o">=</span> <span class="n">context</span>
      <span class="vi">@text</span> <span class="o">=</span> <span class="k">super</span>
      <span class="n">internal_render</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">internal_render</span>
      <span class="o">&lt;&lt;~</span><span class="no">CODEBLOCK</span><span class="sh">
      &lt;div class="pageview"&gt;
        &lt;div class="pageview-header codeblock-header"&gt;.:[</span><span class="si">#{</span><span class="vi">@title</span><span class="si">}</span><span class="sh">]:.&lt;/div&gt;
          </span><span class="si">#{</span><span class="vi">@text</span><span class="si">}</span><span class="sh">
      &lt;/div&gt;
</span><span class="no">      CODEBLOCK</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Liquid</span><span class="o">::</span><span class="no">Template</span><span class="p">.</span><span class="nf">register_tag</span><span class="p">(</span><span class="s1">'codeblock'</span><span class="p">,</span> <span class="no">GlitchWorks</span><span class="o">::</span><span class="no">CodeBlock</span><span class="p">)</span></code></pre></figure>

</div>

<p>As you can see, this class duplicates some of the code from <code>GlitchWorks::Base</code> and <code>GlitchWorks::Block</code>, but there‚Äôs enough difference in what‚Äôs going on that it didn‚Äôt make sense to genericize the code any further. It is, after all, extending a completely different parent class!</p>

<p>Jekyll‚Äôs <code>highlight</code> tag requires that a language be passed in, it takes it as the second argument to <code>initialize</code> via a regex. Simply passing in the contents of the <code>:language</code> parameter when calling <code>super</code> takes care of that. Since ths is a required parameter, we raise a <code>SyntaxError</code> in <code>bind_params</code> if it is not supplied.</p>

<p>Clearly used throughout this document, the codeblock tag block is invoked as such:</p>

<pre><code>{% codeblock :language =&gt; 'ruby', :title =&gt; 'A Ruby Example' %}
puts self.inspect
{% endcodeblock %}
</code></pre>
<p>The HTML is generates is preformatted with many style wrappers, so the output won‚Äôt be shown inline here.</p>

<h2 id="summary">Summary</h2>

<p>Plugins are indeed a simple way to add new Liquid tags to Jekyll, thereby reducing code repition, centralizing configuration, and making Markdown more readable. Hopefully the examples above get you started on your way to writing your own plugins!</p>

<p>Of course, no exercise in code maintenance and refactoring is complete until it‚Äôs turned into a complete <a href="http://catb.org/jargon/html/Y/yak-shaving.html">yak shave</a>. In writing this article, it was discovered that <a href="http://pygments.org/">Python Pygments</a>, a syntax highlighting library, was not correctly handling Ruby ‚Äúsquiggly heredoc,‚Äù which was introduced in Ruby 2.3. Chasing down this bug resulted in a pull request on the <a href="https://github.com/tmm1/pygments.rb/pull/178">pygments.rb gem</a>, as well as a <a href="https://gist.github.com/chapmajs/ea78713bf457c47984bf1be70101696d">patch</a> against the Pygments library and the Pygments SlackBuild!</p>

<p class="center">
    <script language="javascript" src="https://services.glitchworks.net/counters/jekyll_plugins"></script> plugins created
</p>

:ET