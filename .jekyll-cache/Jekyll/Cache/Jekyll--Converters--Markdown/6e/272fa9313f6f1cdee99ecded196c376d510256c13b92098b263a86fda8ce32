I"Ç<p>I‚Äôve recently replaced my aging home router with a plain install of <a href="http://www.openbsd.org">OpenBSD</a>. This means taking care of some of the nice automatic features pfSense provided by hand. This one wasn‚Äôt particularly difficult, but there exist several incomplete or incorrect guides on how to solve it.</p>

<p><a href="https://www.he.net">Hurricane Electric</a> provides free IPv6 tunnels through their <a href="https://www.tunnelbroker.net">tunnelbroker.net</a> service. This allows those of use whose ISPs <em>still</em> don‚Äôt have native IPv6 to easily obtain IPv6 connectivity with zero cost. Their service allows for tunnels with DHCP IPv4 addresses, which of course are common with both residential and small business Internet connections. A tunnel‚Äôs IPv4 address can be updated by providing information to a <a href="https://help.dyn.com/remote-access-api/">Dyn-compatible endpoint</a> in a HTTP GET. Existing tools, such as <a href="https://code.google.com/p/umonkey-tools/wiki/ddupdate">ddupdate</a>, can be configured to work with Hurricane Electric‚Äôs endpoint.</p>

<p>That still leaves the problem of updating the <a href="http://www.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man4/gif.4">gif</a> tunnel on your end. pfSense handles this with a ‚ÄúHE.net Tunnelbroker‚Äù type through DynDNS services. It‚Äôs an exercise left to the reader for OpenBSD. My solution can be found <a href="https://github.com/chapmajs/Examples/blob/master/openbsd/update_he.sh">in my GitHub repository</a>. Here‚Äôs an explanation of how it works:</p>

<h2 id="local-gif-interface">Local gif Interface</h2>

<p>Fairly straightforward, here <code>hostname.gif0</code> is written using <code>ifconfig</code> and <code>awk</code> to figure out the IPv4 address of the egress interface. This gets used to dynamically set the local tunnel endpoint. For this to work, the egress interface must be up before <code>gif0</code> gets created.</p>

<h2 id="hurricane-electric-endpoint">Hurricane Electric Endpoint</h2>

<p>Hurricane Electric‚Äôs Dyn-compliant endpoint will automatically update your tunnel endpoint (and optionally, a DNS A record, if you‚Äôre using <a href="https://dns.he.net">dns.he.net</a> for your DNS) through a HTTP GET. <a href="https://forums.he.net/index.php?topic=1994.0">This page</a> describes the basics of what you need to send to their endpoint:</p>

<ul>
  <li>Username - your tunnelbroker.net username</li>
  <li>Password - tunnel-specific auth key <em>or</em> your tunnelbroker.net password</li>
  <li>Hostname - several options, I chose the numeric tunnel ID</li>
  <li>IP Address - you can optionall send the IP you want to assign</li>
</ul>

<p>The last parameter ‚Äì IP Address ‚Äì is optional. If omitted, the endpoint will use the IP that the request comes in on. This is fine as long as you‚Äôre not load balancing across two or more public IPv4 addresses. This is the method my script uses, since it allows for one less step in updating the tunnel configuration.</p>

<p>Making a HTTP GET request to the HE.net endpoint results in one of several return codes, <a href="https://help.dyn.com/remote-access-api/return-codes/">specified in the Dyn API</a>. We‚Äôll take advantage of those to determine if our update was successful, and the IP to which we are bound. Important return codes:</p>

<ul>
  <li><code>nochg X.X.X.X</code> will be returned if the tunnel endpoint is already set to your current IP</li>
  <li><code>good X.X.X.X</code> will be returned if the tunnel endpoint was updated with a new address</li>
  <li><code>good 127.0.0.1</code> will be returned, unintuitively, if there‚Äôs something wrong with the request (unless you really supplied <code>127.0.0.1</code>)</li>
</ul>

<p>All other return codes are an error condition. This makes it fairly easy to parse good results from the request, and log problems.</p>

<p>In addition to the return status, <code>nochg</code> and <code>good</code> updates return the IP address currently assigned to the endpoint. For a <code>good</code> update that doesn‚Äôt include <code>127.0.0.1</code> as the IP address, we now have our public IP with no additional work. We can then use that information to reconfigure the <code>gif</code> tunnel.</p>

<h2 id="caveats-shortcomings-et-c">Caveats, Shortcomings, et c.</h2>

<p><a href="http://0xfeedface.org">Shawn Webb</a> pointed out that, using this method, the tunnel password will be visible during the <code>curl</code> call in the system process list. Perhaps not an issue on a router, where the only users viewing the process list should be authenticated, but definitely a problem on a multiuser system!</p>

<p>Too many requests of a certain type can be considered ‚Äúabusive‚Äù for Dyn-compliant updates. I ran into this while testing the script ‚Äì it seems that HE.net will quickly generate an ‚Äúabuse‚Äù reply after a small number of queries that result in <code>good 127.0.0.1</code>, such as trying to set your IP to <code>1.2.3.4</code> or <code>8.8.4.4</code>. Additionally, the script consumes more bandwidth than necessary, since it‚Äôs running as a periodic cron task and making a HTTP GET whether it needs to update the tunnel endpoint or not (it doesn‚Äôt keep state).</p>
:ET